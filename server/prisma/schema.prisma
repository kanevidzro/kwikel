generator client {
  provider   = "prisma-client"
  output     = "../prisma/generated"
  engineType = "client"
  runtime    = "bun"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(uuid())
  name          String
  phone         String?   @unique
  email         String    @unique
  password      String
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  projects      Project[]

  verificationTokens  VerificationToken[]
  passwordResetTokens PasswordResetToken[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId, expiresAt])
}

model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  expiresAt DateTime
  userId    String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, userId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token, userId])
}

model Project {
  id     String @id @default(uuid())
  name   String
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  smsMessages SmsMessage[]
  otpMessages OtpMessage[]
  senderIds   SenderId[]
  apiKeys     ApiKey[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  templates Template[]

  campaigns  Campaign[]
  phoneBooks PhoneBook[]

  @@index([userId, createdAt])
}

model ApiKey {
  id         String    @id @default(uuid())
  projectId  String
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  keyHash    String    @unique
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([projectId, isActive])
}

model SenderId {
  id        String  @id @default(uuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String // e.g., "DUGBLE"
  purpose   String?
  status    String // PENDING, APPROVED, REJECTED, WHITELISTED

  smsMessages SmsMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, name])
}

model SmsMessage {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  sender String // e.g. "DUGBLE"

  recipient   String
  message     String
  status      String // QUEUED, SENT, DELIVERED, FAILED
  unitsUsed   Int
  countryCode String? // e.g., "GH", "NG"

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  senderId   SenderId? @relation(fields: [senderIdId], references: [id])
  senderIdId String?
  template   Template? @relation(fields: [templateId], references: [id])
  templateId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])
  campaignId String?

  @@index([projectId, createdAt])
}

model OtpMessage {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  recipient   String
  code        String
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  expiresAt   DateTime
  verifiedAt  DateTime?
  channel     String // SMS, EMAIL
  status      String // PENDING, VERIFIED, EXPIRED
  metadata    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipient, channel, status])
  @@index([expiresAt])
}

model Template {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name      String
  content   String
  category  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  smsMessages SmsMessage[]
  campaigns   Campaign[]

  @@unique([projectId, name])
}

model PhoneBook {
  id           String   @id @default(cuid())
  projectId    String
  name         String
  description  String?
  contactCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  contacts  Contact[]
  campaigns Campaign[]

  @@unique([projectId, name])
  @@index([projectId])
}

model Contact {
  id          String   @id @default(cuid())
  phoneBookId String
  name        String
  email       String?
  phone       String
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  phoneBook PhoneBook @relation(fields: [phoneBookId], references: [id])

  @@unique([phoneBookId, phone])
  @@index([phoneBookId])
  @@index([phone])
}

model Campaign {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  content     String
  scheduledAt DateTime?
  status      String // DRAFT, SCHEDULED, SENT, CANCELLED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])

  phoneBookId String?
  phoneBook   PhoneBook? @relation(fields: [phoneBookId], references: [id])

  smsMessages SmsMessage[]

  @@index([projectId, status])
}
